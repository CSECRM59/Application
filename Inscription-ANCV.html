  <script>
    // --- INITIALISATION DE FIREBASE (identique) ---
    const firebaseConfig = { /* ... votre config ... */
        apiKey: "AIzaSyCzlrRY437eu0tUCqK99OXtOeyOdYSUYsw", authDomain: "appli-cse-56b03.firebaseapp.com", projectId: "appli-cse-56b03", storageBucket: "appli-cse-56b03.firebasestorage.app", messagingSenderId: "892776841086", appId: "1:892776841086:web:2a1a7c60be011fda0afd2f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- LOGIQUE DU FORMULAIRE ANCV (adaptée avec vérification doublon) ---
    document.addEventListener('DOMContentLoaded', () => {
        const ancvForm = document.getElementById('ancvForm');
        const accordCheckbox = document.getElementById('ancv-accord');
        const emailInput = document.getElementById('ancv-email'); // Récupérer l'input email
        const submitBtn = document.getElementById('ancv-submit-btn');
        const statusDiv = document.getElementById('ancv-status');
        const confirmDiv = document.getElementById('ancv-confirmation');
        const errorDiv = document.getElementById('ancv-error');

        // Gestion visuelle de la checkbox (identique)
        if (accordCheckbox) {
            const accordLabel = accordCheckbox.closest('.checkbox-label');
            accordCheckbox.addEventListener('change', () => { /* ... code identique ... */ accordLabel?.classList.toggle('is-checked', accordCheckbox.checked);});
            if (accordLabel) {accordLabel.classList.toggle('is-checked', accordCheckbox.checked);}
        }

        if (ancvForm) {
            ancvForm.addEventListener('submit', e => {
                e.preventDefault();

                // --- VALIDATION CHECKBOX (identique) ---
                if (!accordCheckbox.checked) {
                    errorDiv.textContent = "Veuillez cocher la case pour confirmer votre participation aux conditions indiquées.";
                    errorDiv.style.display = 'block';
                    accordCheckbox.focus();
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                // ------------------------------------------

                // Cacher les messages, afficher l'envoi, désactiver le bouton
                confirmDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                statusDiv.style.display = 'block';
                submitBtn.disabled = true;

                // Récupérer l'email et le mettre en minuscule pour la comparaison/stockage
                const emailToCheck = emailInput.value.trim().toLowerCase();
                const nom = document.getElementById('ancv-nom').value.trim();
                const prenom = document.getElementById('ancv-prenom').value.trim();

                // === VÉRIFICATION DOUBLON DANS FIRESTORE ===
                db.collection('ANCV')
                  .where('emailPerso', '==', emailToCheck) // Chercher les docs avec cet email (en minuscule)
                  .limit(1) // On a juste besoin de savoir s'il en existe au moins un
                  .get()
                  .then(snapshot => {
                      if (!snapshot.empty) {
                          // --- DOUBLON TROUVÉ ---
                          console.warn("Tentative d'inscription ANCV dupliquée pour:", emailToCheck);
                          errorDiv.textContent = "Une inscription avec cette adresse email personnelle a déjà été enregistrée. Veuillez contacter le CSE si besoin.";
                          errorDiv.style.display = 'block';
                          statusDiv.style.display = 'none'; // Cacher "Envoi en cours"
                          submitBtn.disabled = false; // Réactiver le bouton
                          errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

                      } else {
                          // --- AUCUN DOUBLON TROUVÉ -> Procéder à l'inscription ---
                          console.log("Aucune inscription ANCV existante pour:", emailToCheck, ". Procédure d'ajout...");

                          const data = {
                            nom: nom,
                            prenom: prenom,
                            emailPerso: emailToCheck, // Enregistrer l'email en minuscule
                            accordParticipation: true,
                            conditionTexte: accordCheckbox.closest('label').textContent.replace(/[\n\r]+|[\s]{2,}/g, ' ').trim(),
                            timestampSoumission: firebase.firestore.FieldValue.serverTimestamp()
                          };

                          // Envoi à Firestore
                          db.collection('ANCV').add(data)
                            .then(() => {
                              statusDiv.style.display = 'none';
                              confirmDiv.style.display = 'block';
                              ancvForm.reset();
                              if (accordCheckbox && accordCheckbox.closest('.checkbox-label')) {
                                 accordCheckbox.closest('.checkbox-label').classList.remove('is-checked');
                              }
                              submitBtn.disabled = false;
                              confirmDiv.scrollIntoView({ behavior: 'smooth' });
                            })
                            .catch(error => {
                              // Erreur lors de l'AJOUT
                              console.error("Erreur ajout formulaire ANCV:", error);
                              statusDiv.style.display = 'none';
                              errorDiv.textContent = "Erreur lors de l'enregistrement. Veuillez réessayer ou contacter le CSE.";
                              errorDiv.style.display = 'block';
                              submitBtn.disabled = false;
                              errorDiv.scrollIntoView({ behavior: 'smooth' });
                            });
                      }
                  })
                  .catch(error => {
                      // Erreur lors de la VÉRIFICATION (requête .get())
                      console.error("Erreur vérification doublon ANCV:", error);
                      statusDiv.style.display = 'none';
                      errorDiv.textContent = "Erreur lors de la vérification de l'inscription. Veuillez réessayer.";
                      errorDiv.style.display = 'block';
                      submitBtn.disabled = false; // Réactiver le bouton
                  });
                // =========================================
            });
        }
    });
  </script>
